package com.objectcomputing.checkins.services.settings;

import com.objectcomputing.checkins.services.permissions.Permission;
import com.objectcomputing.checkins.services.permissions.RequiredPermission;
import com.objectcomputing.checkins.exceptions.BadArgException;
import com.objectcomputing.checkins.exceptions.NotFoundException;
import jakarta.inject.Singleton;
import jakarta.validation.constraints.NotNull;

import java.util.List;
import java.util.UUID;

@Singleton
public class SettingsServicesImpl implements SettingsServices {

    private final SettingsRepository settingsRepository;

    public SettingsServicesImpl(SettingsRepository settingsRepository) {
        this.settingsRepository = settingsRepository;
    }

    @Override
    @RequiredPermission(Permission.CAN_ADMINISTER_SETTINGS)
    public Setting save(Setting setting) {
        if (setting.getId() != null) {
            throw new BadArgException("Setting ID is autogenerated by the server upon creation, and should not be provided.");
        }
        validateSettingOption(setting.getName());
        return settingsRepository.save(setting);
    }

    @Override
    @RequiredPermission(Permission.CAN_ADMINISTER_SETTINGS)
    public Setting update(String name, String value) {
        validateSettingOption(name);
        Setting setting = settingsRepository.findByName(name)
                .orElseThrow(() -> new NotFoundException("Setting with name " + name + " not found."));
        setting.setValue(value);
        return settingsRepository.update(setting);
    }

    @Override
    @RequiredPermission(Permission.CAN_VIEW_SETTINGS)
    public Setting findByName(@NotNull String name) {
        return settingsRepository.findByName(name)
                .orElseThrow(() -> new NotFoundException("Setting with name " + name + " not found."));
    }

    @Override
    @RequiredPermission(Permission.CAN_VIEW_SETTINGS)
    public List<Setting> findAllSettings() {
        return settingsRepository.findAll();
    }

    @Override
    @RequiredPermission(Permission.CAN_ADMINISTER_SETTINGS)
    public boolean delete(@NotNull UUID id) {
        if (!settingsRepository.existsById(id)) {
            throw new NotFoundException("No setting with id " + id);
        }
        settingsRepository.deleteById(id);
        return true;
    }

    private void validateSettingOption(String name) {
        if(!SettingOption.isValidOption(name)){
            throw new BadArgException("Provided setting name is invalid.");
        }
    }
}
